<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MICRO-SWARM // OMEGA_INTERFACE</title>
    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Jura:wght@300;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;900&display=swap');

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); }
        body { margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        canvas { position: absolute; top: 0; left: 0; z-index: -1; }

        /* --- LAYOUT --- */
        #app-container {
            display: grid;
            width: 100%; height: 100%;
            padding: 20px;
            gap: 20px;
            z-index: 10;
        }

        /* --- THEME 1: HACKER (Grid Command Center) --- */
        body.hacker { background: #000; color: #0f0; font-family: 'VT323', monospace; }
        .hacker #app-container {
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 60px 1fr;
            grid-template-areas: "header header header" "controls terminal telemetry";
        }
        .hacker .panel { border: 1px solid #0f0; background: rgba(0, 20, 0, 0.85); box-shadow: 0 0 15px rgba(0, 255, 0, 0.2); }
        .hacker button { border-radius: 0; text-transform: uppercase; letter-spacing: 2px; }
        .hacker .bar-fill { background: #0f0; box-shadow: 0 0 10px #0f0; }

        /* --- THEME 2: NINJA (Floating Glass Minimalist) --- */
        body.ninja { background: #1a1a1a; color: #e0e0e0; font-family: 'Jura', sans-serif; }
        .ninja #app-container {
            display: flex; align-items: center; justify-content: center; padding: 50px; gap: 40px;
        }
        .ninja header { position: absolute; top: 20px; left: 50px; border: none !important; }
        .ninja #panel-controls { width: 250px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); order: 1; }
        .ninja #panel-terminal { flex-grow: 1; max-width: 800px; height: 80%; background: rgba(0, 0, 0, 0.6); border-radius: 30px; border: 1px solid #333; order: 2; }
        .ninja #panel-telemetry { width: 250px; background: transparent; border: none; order: 3; }
        .ninja button { border-radius: 50px; background: #fff; color: #000; font-weight: 900; }
        .ninja .bar-fill { background: #fff; }

        /* --- THEME 3: DRAGON (Ancient Scroll) --- */
        body.dragon { background: #050000; color: #ffb700; font-family: 'Cinzel Decorative', serif; }
        .dragon #app-container {
            display: grid; grid-template-columns: 1fr 800px 1fr; grid-template-rows: 100px 1fr;
            grid-template-areas: ". header ." "controls terminal telemetry";
        }
        .dragon header { text-align: center; border-bottom: 2px double #ff4500 !important; justify-content: center !important; }
        .dragon .panel { background: rgba(20, 0, 0, 0.9); border: 2px solid #8B0000; border-radius: 4px; box-shadow: inset 0 0 50px #330000; }
        .dragon #panel-terminal { border-left: 5px solid #ffb700; border-right: 5px solid #ffb700; background: linear-gradient(to bottom, #1a0500, #000); }
        .dragon button { background: linear-gradient(45deg, #8B0000, #ff4500); border: 1px solid gold; color: gold; }
        .dragon .bar-fill { background: linear-gradient(90deg, #ff4500, gold); }

        /* --- COMMON UI --- */
        header { grid-area: header; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid currentColor; }
        h1 { margin: 0; }
        #panel-controls { grid-area: controls; padding: 20px; display: flex; flex-direction: column; }
        #panel-terminal { grid-area: terminal; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #panel-telemetry { grid-area: telemetry; padding: 20px; }
        .panel { transition: all 0.5s ease; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1); border: 1px solid currentColor; color: currentColor; font-family: inherit; font-size: 1rem; outline: none; }
        button { width: 100%; padding: 15px; margin-bottom: 10px; cursor: pointer; border: 1px solid currentColor; font-family: inherit; font-size: 1.1rem; }
        
        /* --- GRAPHS --- */
        .metric-label { display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 5px; }
        .bar-bg { width: 100%; height: 12px; background: rgba(255,255,255,0.1); margin-bottom: 15px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }

        /* --- WORLD SELECTOR --- */
        #world-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: row; align-items: stretch; }
        .world-option { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; transition: 0.4s; border-right: 1px solid #333; }
        .world-option:hover { flex: 2; }
        .world-option h2 { z-index: 2; font-size: 2rem; text-shadow: 0 0 20px black; text-align: center; }
        
        .opt-hacker { background: #001100; color: #0f0; font-family: 'VT323'; }
        .opt-hacker:hover { background: #003300; box-shadow: inset 0 0 50px #0f0; }
        
        .opt-ninja { background: #111; color: #fff; font-family: 'Jura'; }
        .opt-ninja:hover { background: #222; box-shadow: inset 0 0 50px #fff; }
        
        .opt-dragon { background: #1a0500; color: #ffb700; font-family: 'Cinzel Decorative'; }
        .opt-dragon:hover { background: #330000; box-shadow: inset 0 0 50px #ff4500; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: currentColor; }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>

    <div id="world-overlay">
        <div class="world-option opt-hacker" onclick="enterWorld('hacker')"><h2>HACKER<br>REALITY</h2></div>
        <div class="world-option opt-ninja" onclick="enterWorld('ninja')"><h2>NINJA<br>REALITY</h2></div>
        <div class="world-option opt-dragon" onclick="enterWorld('dragon')"><h2>DRAGON<br>REALITY</h2></div>
    </div>

    <div id="app-container">
        <header>
            <h1>MICRO-SWARM <span style="font-size:0.5em; opacity:0.7">// V3.0</span></h1>
            <div id="status-ind">SYSTEM ONLINE</div>
        </header>

        <div id="panel-controls" class="panel">
            <h2>COMMAND</h2>
            <select id="langSelect"><option value="Python">Python Core</option><option value="C++">C++ Core</option></select>
            <input type="text" id="userInput" placeholder="Enter objective..." onkeypress="handleEnter(event)">
            <button onclick="runSwarm()">EXECUTE</button>
            <button onclick="startVoice()">VOICE UPLINK</button>
        </div>

        <div id="panel-terminal" class="panel">
            <h2>TERMINAL OUTPUT</h2>
            <div id="terminal-content" style="flex-grow:1; overflow-y:auto; line-height:1.5;">
                <div style="opacity:0.5">Neural Link Established... Waiting for directive.</div>
            </div>
        </div>

        <div id="panel-telemetry" class="panel">
            <h2>PERFORMANCE GRAPHS</h2>
            
            <div class="metric-label"><span>ARCHITECT (PLAN)</span><span id="val-arch">0.0s</span></div>
            <div class="bar-bg"><div id="bar-arch" class="bar-fill"></div></div>

            <div class="metric-label"><span>EVOLUTION (CODE)</span><span id="val-evo">0.0s</span></div>
            <div class="bar-bg"><div id="bar-evo" class="bar-fill"></div></div>

            <div class="metric-label"><span>SANDBOX (QA)</span><span id="val-qa">0.0s</span></div>
            <div class="bar-bg"><div id="bar-qa" class="bar-fill"></div></div>

            <div style="margin-top:20px; font-size:0.8em; border-top:1px solid currentColor; padding-top:10px;">
                ACTIVE THEME: <span id="theme-name">NONE</span><br>
                STATUS: <span id="run-status">IDLE</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let currentTheme = '';
        let particles = [];

        function enterWorld(theme) {
            document.body.className = theme;
            currentTheme = theme;
            document.getElementById('theme-name').innerText = theme.toUpperCase();
            const overlay = document.getElementById('world-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 600);
            initCanvas();
        }

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particles = [];
            if (currentTheme === 'hacker') {
                const cols = Math.floor(canvas.width / 20);
                for (let i = 0; i < cols; i++) particles[i] = 1;
            } else if (currentTheme === 'ninja') {
                for(let i=0; i<50; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5), vy: (Math.random()-0.5) });
            } else if (currentTheme === 'dragon') {
                for(let i=0; i<80; i++) particles.push({ x: Math.random()*canvas.width, y: canvas.height + Math.random()*100, s: Math.random()*4+1, v: Math.random()*3+1 });
            }
        }

        function animate() {
            ctx.fillStyle = (currentTheme === 'hacker') ? 'rgba(0,0,0,0.05)' : 'rgba(0,0,0,0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (currentTheme === 'hacker') {
                ctx.fillStyle = '#0f0'; ctx.font = '16px monospace';
                particles.forEach((y, i) => {
                    const text = String.fromCharCode(0x30A0 + Math.random() * 96);
                    ctx.fillText(text, i * 20, y * 20);
                    if (y * 20 > canvas.height && Math.random() > 0.975) particles[i] = 0;
                    particles[i]++;
                });
            } else if (currentTheme === 'ninja') {
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                    p.x += p.vx; p.y += p.vy;
                    if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                });
            } else if (currentTheme === 'dragon') {
                ctx.fillStyle = 'rgba(255, 100, 0, 0.6)';
                particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    p.y -= p.v; p.x += Math.sin(p.y*0.05);
                    if(p.y < 0) p.y = canvas.height;
                });
            }
            requestAnimationFrame(animate);
        }
        window.addEventListener('resize', initCanvas);
        animate();

        // --- BACKEND LOGIC ---
        async function runSwarm() {
            const input = document.getElementById('userInput');
            const term = document.getElementById('terminal-content');
            const lang = document.getElementById('langSelect').value;
            const cmd = input.value;
            if(!cmd) return;

            term.innerHTML += `<div style="margin-top:10px; border-left:2px solid currentColor; padding-left:10px;">USER: ${cmd}</div>`;
            input.value = "";
            term.scrollTop = term.scrollHeight;
            document.getElementById('run-status').innerText = "PROCESSING...";

            // Fake animation while waiting
            const fake = setInterval(() => {
                document.getElementById('bar-arch').style.width = Math.random()*100 + "%";
                document.getElementById('bar-evo').style.width = Math.random()*100 + "%";
            }, 100);

            try {
                const res = await fetch("http://localhost:8080/api/swarm", { method: "POST", body: `${lang}|${cmd}` });
                const txt = await res.text();
                clearInterval(fake);
                document.getElementById('run-status').innerText = "COMPLETE";

                // PARSE GRAPHS FROM C++ OUTPUT
                parseGraphs(txt);

                // Clean text for display (remove raw graph data from text view)
                const cleanText = txt.split("[SYSTEM METRICS")[0];
                const formatted = cleanText.replace(/</g, "&lt;").replace(/\n/g, "<br>");
                term.innerHTML += `<div style="margin-top:10px; color:currentColor; opacity:0.9;">${formatted}</div>`;
                term.scrollTop = term.scrollHeight;
            } catch(e) {
                clearInterval(fake);
                term.innerHTML += `<div style="color:red">ERROR: Connection Failed</div>`;
            }
        }

        function parseGraphs(responseText) {
            // Extract times using Regex from the C++ ASCII table
            const archMatch = responseText.match(/Architect\s+\|\s+#*\s+([\d.]+)s/);
            const evoMatch = responseText.match(/Evolution\s+\|\s+#*\s+([\d.]+)s/);
            const qaMatch = responseText.match(/Sandbox QA\s+\|\s+#*\s+([\d.]+)s/);

            const tArch = archMatch ? parseFloat(archMatch[1]) : 0;
            const tEvo = evoMatch ? parseFloat(evoMatch[1]) : 0;
            const tQa = qaMatch ? parseFloat(qaMatch[1]) : 0;

            const total = Math.max(tArch + tEvo + tQa, 0.1); // Avoid div/0

            // Update UI Bars (Relative Scale)
            document.getElementById('val-arch').innerText = tArch + "s";
            document.getElementById('bar-arch').style.width = (tArch / total * 100) + "%";

            document.getElementById('val-evo').innerText = tEvo + "s";
            document.getElementById('bar-evo').style.width = (tEvo / total * 100) + "%";

            document.getElementById('val-qa').innerText = tQa + "s";
            document.getElementById('bar-qa').style.width = (tQa / total * 100) + "%";
        }

        function handleEnter(e) { if(e.key==='Enter') runSwarm(); }
        function startVoice() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) return alert("Voice not supported");
            const r = new SR(); r.start();
            document.getElementById('userInput').placeholder = "Listening...";
            r.onresult = (e) => {
                document.getElementById('userInput').value = e.results[0][0].transcript;
                runSwarm();
            };
        }
    </script>
</body>
</html>